<div style="text-align:left">
    <h1 class="header">评论管理</h1>

    <div id="counts"></div>
    <table id="comments" class="ui compact celled striped table"></table>

    <div id="actions" class="ui buttons">
        <button class="ui disabled button" id="delete">删除</button>
        <button class="ui disabled button" id="approved">审核通过</button>
        <button class="ui disabled button" id="waiting">等待审核</button>
        <button class="ui disabled button" id="spam">垃圾评论</button>
    </div>
    <div id="pages" class="ui right floated buttons">
        <button class="ui button page" data-page="0">第一页</button>
        <button class="ui button page" id="prev" data-page="0">上一页</button>
        <button class="ui button page" id="next" data-page="0">下一页</button>
    </div>
</div>

<script>
function pageInit(){
    loadCounts();
    loadComments(0);
    initActions();

    function initActions() {
        $('#pages .page').on('click', function(){
            var page = $(this).attr('data-page');
            loadComments(page);
        });

        $('#delete').on('click', function(){
            $('#comments input:checked').each(function(index, elem){
                var id = $(elem).val();
                app.delete({
                    'url': app.adminAPI('/comments/'+id)
                }).done(function(){
                    $(elem).parents('tr').remove();
                });
            });
        });

        $('#approved').on('click', function(){
            $('#comments input:checked').each(function(index, elem){
                var id = $(elem).val();
                app.post({
                    'url': app.adminAPI('/comments/'+id+'/approved')
                }).done(function(){
                    $(elem).prop('checked', false);
                });
            });
        });

        $('#spam').on('click', function(){
            $('#comments input:checked').each(function(index, elem){
                var id = $(elem).val();
                app.post({
                    'url': app.adminAPI('/comments/'+id+'/spam')
                }).done(function(){
                    $(elem).prop('checked', false);
                });
            });
        });

        $('#waiting').on('click', function(){
            $('#comments input:checked').each(function(index, elem){
                var id = $(elem).val();
                app.post({
                    'url': app.adminAPI('/comments/'+id+'/waiting')
                }).done(function(){
                    $(elem).prop('checked', false);
                });
            });
        });
    } // end initActions

    function loadCounts() {
        app.get({
            'url': app.adminAPI('/comments/count')
        }).done(function(data, textStatus, jqXHR){
            app.loadTemplate('#counts', '#counts-template', data);
        });
    }

    function loadComments(page) {
        return app.get({
            'url': app.adminAPI('/comments?size='+size+'&page='+page)
        }).done(function(data, textStatus, jqXHR){
            // 加载页码导航
            if (page > 0){
                $('#prev').attr('data-page', page-1);
            }
            if (page*size < data.count){
                $('#next').attr('data-page', page+1);
            }

            // 初始化评论列表数据
            $.each(data.comments, function(index, elem){
                switch (parseInt(elem.state)) { // TODO 去掉parsetInt
                    case 1: // waiting
                        elem.stateText = '等待审核';
                        break;
                    case 2: // spam
                        elem.stateText = '垃圾评论';
                        break
                    case 3: // approved
                        elem.stateText = '已审核';
                        break
                    default:
                        elem.stateText = '未知状态:'+elem.state;
                }
            });

            // 加载评论列表
            $('#comments').html('');
            app.loadTemplate('#comments', '#comments-template', data);
            $('.ui.checkbox').checkbox();

            // 初始化checkbox事件
            $('#comments input').on('change', function(){
                updateActions();
            });
        });
    } // end loadComments

    function updateActions() {
        var l = $('#comments input:checked').length;
        switch (l) {
            case 0:
                $('#delete').addClass('disabled').removeClass('red');
                $('#approved').addClass('disabled').removeClass('green');
                $('#spam').addClass('disabled').removeClass('red');
                $('#waiting').addClass('disabled').removeClass('blue');
                break;
            default:
                $('#delete').removeClass('disabled').addClass('red');
                $('#approved').removeClass('disabled').addClass('green');
                $('#spam').removeClass('disabled').addClass('red');
                $('#waiting').removeClass('disabled').addClass('blue');
        }
    }
} // end pageInit
</script>

<!-- 顶部标签模板 -->
<script id="counts-template" type="x-template-handlebars">
    <span class="ui label">所有<span class="detail">{{all}}</span></span>
    <span class="ui green label">已审核<span class="detail">{{approved}}</span></span>
    <span class="ui yellow label">待审核<span class="detail">{{waiting}}</span></span>
    <span class="ui red label">垃圾<span class="detail">{{spam}}</span></span>
</script>

<!-- 表格模板 -->
<script id="comments-template" type="x-template-handlebars">
<thead>
    <tr>
        <th>ID</th>
        <th class="six wide">评论内容</th>
        <th>所属文章</th>
        <th>用户信息</th>
        <th>状态</th>
    </tr>
</thead>
<tbody>
{{#comments}}
    <tr>
        <td>
            <div class="ui checkbox">
                <label>{{id}}</label>
                <input type="checkbox" value="{{id}}" />
            </div>
        </td>
        <td>{{content}}</td>
        <td>{{postTitle}}</td>
        <td>{{authorName}}<br />{{authorURL}}<br />{{authorEmail}}</td>
        <td>{{stateText}}</td>
    </tr>
{{/comments}}
</tbody>
</script>
