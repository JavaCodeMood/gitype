<div class="config-div">
    <h1 class="header">用户信息</h1>
    <form class="ui form" id="userForm">
        <div class="field">
            <label for="screenName">用户昵称</label>
            <input id="screenName" type="text" value="" />
            <div class="descriptional">所有前端页面都将显示此名称。</div>
        </div>

        <div class="field">
            <label for="email">用户邮箱</label>
            <input id="email" type="text" value="" />
            <div class="descriptional">用户邮箱，将会在部分前端页面展示在。</div>
        </div>
    </form>

    <br /><br />
    <form class="ui form" id="changePasswordForm">
        <div class="ui horizontal divider header">更新密码</div>

        <div class="field">
            <label for="oldPassword">旧密码</label>
            <input id="oldPassword" type="password" name="oldPassword" value="" />
        </div>

        <div class="field">
            <label for="newPassword">新密码</label>
            <input id="newPassword" type="password" name="newPassword" value="" />
        </div>

        <div class="field">
            <label for="retryPassword">确认新密码</label>
            <input id="retryPassword" type="password" name="retryPassword" value="" />
        </div>

        <div class="field">
            <button type="submit" class="ui primary fluid button">确认更新密码</button>
        </div>
    </form>
</div>

<script>
function pageInit(){
    app.setTitle('用户信息');

    /* BEGIN -- get */
    $('#userForm').addClass('loading');
    $.when(getData('screenName'), getData('email')).always(function(){
        $('#userForm').removeClass('loading');
    });
    /* END -- get */

    /* BEGIN -- patch */
    patchData('screenName')
    patchData('email')
    /* END -- patch */

    /* BEGIN -- update password */
    $('#changePasswordForm').on('submit', function(){
        if (!$('#oldPassword').val()) {
            app.showMessage('red', '旧密码不能为空');
            return false;
        }
        if (!$('#newPassword').val()) {
            app.showMessage('red', '新密码不能为空');
            return false;
        }
        if ($('#newPassword').val() != $('#retryPassword').val()) {
            app.showMessage('red', '两次新密码不相同');
            return false;
        }
        if ($('#oldPassword').val() == $('#newPassword').val()) {
            app.showMessage('red', '新旧密码是一样的，不需要更改');
            return false;
        }

        $('#changePasswordForm').addClass('loading');
        app.put({
            'url': app.adminAPI('/password'),
            'data':JSON.stringify({'old':$('#oldPassword').val(), 'new':$('#newPassword').val()})
        }).done(function() {
            app.showMessage('green', '更新密码成功');
            $('#oldPassword').val('');
            $('#newPassword').val('');
            $('#retryPassword').val('');
        }).fail(function(jqXHR, textStatus, errorThrown) {
            app.showMessage('red', '更新密码失败:'+errorThrown);
        }).always(function(){
            $('#changePasswordForm').removeClass('loading');
        });

        return false
    });
    /* END -- update password */

    function getData(id){
        app.get({
            'url': app.adminAPI('/options/'+id)
        }).done(function(data, textStatus, jqXHR) {
            $('#'+id).attr('data-default', data.value);
            $('#'+id).val(data.value);
        }).fail(function() {
            app.showMessage('red', '无法加载'+id+'设置项的值！');
        });
    }

    function patchData(id){
        $('#'+id).on('blur', function(){
            var elem = $('#'+id);
            if (elem.attr('data-default') == elem.val()) {
                return
            }

            app.patch({
                'url': app.adminAPI('/options/'+id),
                'data':JSON.stringify({'value': elem.val()})
            }).done(function(){
                elem.attr('data-default', elem.val());
                app.showMessage('green', '设置已经保存');
            }).fail(function(){
                elem.val(elem.attr('data-default'));
                app.showMessage('red', '无法更新'+id+'设置项的值！');
            });
        });
    }
} // end pageInit
</script>
