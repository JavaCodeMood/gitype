<h1 class="header">仪表盘</h1>

<div id="dashboard-container" class="ui two stackable cards">
</div>

<script>
function pageInit(){
    app.setTitle('仪表盘');

    app.get({
        'url': app.adminAPI('/state')
    }).done(function(data, textStatus, jqXHR){
        data.lastUpdated = (new Date(data.lastUpdated*1000)).toLocaleString();
        var last = JSON.parse(data.last);
        data.time = last[1].time;
        data.ip = last[1].ip;
        data.agent = last[1].agent;
        app.loadTemplate('#dashboard-container', '#dashboard-template', data);

        // 加载完模板之后，再尝试加载控制模块的子模板
        loadModulesState();
    });

    function loadModulesState(){
        app.get({
            'url': app.adminAPI('/modules')
        }).done(function(data, textStatus, jqXHR){
            var modules = data.modules;
            for(var i=0; i< data.modules.length; i++){
                if (modules[i].isRunning){
                    modules[i].stateText = '运行中...';
                    modules[i].icon = 'stop';
                }else{
                    modules[i].stateText = '已停止';
                    modules[i].icon = 'play';
                }
            }
            $('#dashboard-modules-container').html('');
            app.loadTemplate('#dashboard-modules-container', '#dashboard-modules-template', modules);

            // 初始化按钮事件
            $('#dashboard-modules-container .meta i').on('click', function(){
                var name = $(this).attr('data-name');
                var state = $(this).attr('data-state');

                var key = 'stop';
                if (state == 'play'){
                    key = 'start';
                }

                app.put({
                    'url': app.adminAPI('/modules/'+name+'/'+key)
                }).done(function(){
                    loadModulesState();
                });
            });
        });
    }
    
} // end pageInit
</script>


<script type="x-handler-template" id="dashboard-template">
    <div class="ui card">
        <div class="content left aligned">
            最后更新
            <div class="right floated meta" id="last-updated">{{lastUpdated}}</div>
        </div>

        <div class="content left aligned">
            文章
            <div class="right floated meta">{{posts}}</div>
        </div>

        <div class="content left aligned">
            已发布
            <div class="right floated meta">{{publishedPosts}}</div>
        </div>

        <div class="content left aligned">
            草稿
            <div class="right floated meta">{{draftPosts}}</div>
        </div>
    </div>

    <div class="ui card">
        <div class="content left aligned">
            评论
            <div class="right floated meta">{{comments}}</div>
        </div>

        <div class="content left aligned">
            已审核
            <div class="right floated meta">{{approvedComments}}</div>
        </div>

        <div class="content left aligned">
            待审核
            <div class="right floated meta">{{waitingComments}}</div>
        </div>

        <div class="content left aligned">
            垃圾评论
            <div class="right floated meta">{{spamComments}}</div>
        </div>
    </div>

    <div class="ui card" id="dashboard-modules-container"></div>

    <div class="ui card">
        <div class="content left aligned">
            最后登录
        </div>

        <div class="content left aligned">
            时间
            <div class="right floated meta">{{time}}</div>
        </div>
        <div class="content left aligned">
            IP
            <div class="right floated meta">{{ip}}</div>
        </div>
        <div class="content left aligned">
            浏览器标志
            <div class="right floated meta">{{agent}}</div>
        </div>
    </div>
</script>

<script type="x-handler-template" id="dashboard-modules-template">
    <div class="content left aligned">
        模块控制
    </div>
    {{#each this}}
    <div class="content left aligned">
        {{name}}
        <div class="right floated meta"><i data-name="{{name}}" data-state="{{icon}}" class="{{icon}} icon"></i>&#160;{{stateText}}</div>
    </div>
    {{/each}}
</script>
