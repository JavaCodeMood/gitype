<div class="config-div">
    <h1 class="header">Sitemap</h1>
    <div class="ui form">
        <div class="field">
            <button id="rebuild" class="ui primary fluid button">重新生成Sitemap</button>
        </div>

        <div class="ui horizontal divider header">changefreq/priority</div>

        <div class="inline field">
            <label for="postsChangefreq">文章</label>
            <select name="postsChangefreq" id="postsChangefreq" class="ui dropdown">
                <option value="always">保持最新</option>
                <option value="hourly">每小时</option>
                <option value="daily">每天</option>
                <option value="weekly">每周</option>
                <option value="monthly">每月</option>
                <option value="never">从不更新</option>
            </select>

            <div class="ui left labeled input" style="margin-left:1em">
                <div class="ui basic label">0.</div>
                <input type="number" min="0" max="10" name="postsPriority" id="postsPriority" />
            </div>
        </div>

        <div class="inline field">
            <label for="tagsChangefreq">标签</label>
            <select name="tagsChangefreq" id="tagsChangefreq" class="ui dropdown">
                <option value="always">保持最新</option>
                <option value="hourly">每小时</option>
                <option value="daily">每天</option>
                <option value="weekly">每周</option>
                <option value="monthly">每月</option>
                <option value="never">从不更新</option>
            </select>


            <div class="ui left labeled input" style="margin-left:1em">
                <div class="ui basic label">0.</div>
                <input type="number" min="0" max="10" name="tagsPriority" id="tagsPriority" />
            </div>
        </div>

        <div class="inline field">
            <label for="catsChangefreq">分类</label>
            <select name="catsChangefreq" id="catsChangefreq" class="ui dropdown">
                <option value="always">保持最新</option>
                <option value="hourly">每小时</option>
                <option value="daily">每天</option>
                <option value="weekly">每周</option>
                <option value="monthly">每月</option>
                <option value="never">从不更新</option>
            </select>

            <div class="ui left labeled input" style="margin-left:1em">
                <div class="ui basic label">0.</div>
                <input type="number" min="0" max="10" name="catsPriority" id="catsPriority" />
            </div>
        </div>
    </div> <!-- end .ui.form -->
</div>

<script>
function pageInit(){
    function getChangefreq(id){
        return app.get({
            'url': app.adminAPI('/options/'+id)
        }).done(function(data, textStatus, jqXHR){
            $('#'+id).val(data.value);
            $('#'+id).attr('data-default', data.value);
        }).fail(function(){
            app.showMessage('red', '加载'+id+'资源失败');
        });
    }

    function getPriority(id){
        return app.get({
            'url': app.adminAPI('/options/'+id)
        }).done(function(data, textStatus, jqXHR){
            var val = parseFloat(data.value) * 10;
            $('#'+id).val(val);
            $('#'+id).attr('data-default', val);
        }).fail(function(){
            app.showMessage('red', '加载'+id+'资源失败');
        });
    }

    function patchChangefreq(id) {
        $('#'+id).on('change', function(){
            var elem = $('#'+id)
            if (elem.attr('data-default') == elem.val()) {
                return
            }

            app.patch({
                'url': app.adminAPI('/options/'+id),
                'data':JSON.stringify({"value": elem.val()})
            }).done(function(){
                elem.attr('data-default', elem.val());
                app.showMessage('green', '设置已经保存');
            }).fail(function(){
                elem.val(elem.attr('data-default'));
                app.showMessage('red', '更新'+id+'资源失败');
            });
        });
    }

    function patchPriority(id) {
        $('#'+id).on('blur', function(){
            var elem = $('#'+id)
            if (elem.attr('data-default') == elem.val()) {
                return
            }

            app.patch({
                'url': app.adminAPI('/options/'+id),
                'data':JSON.stringify({"value": (parseFloat(elem.val()) / 10).toString()})
            }).done(function(){
                elem.attr('data-default', elem.val());
                app.showMessage('green', '设置已经保存');
            }).fail(function(){
                elem.val(elem.attr('data-default'));
                app.showMessage('red', '更新'+id+'资源失败');
            });
        });
    }

    app.setTitle('Sitemap');

    $('#rebuild').on('click', function(){
        $('#rebuild').addClass('loading');
        app.put({
            'url': app.adminAPI('/sitemap'),
            'data':'{}'
        }).done(function(data, textStatus, jqXHR){
            app.showMessage('green', '成功生成新的sitemap');
        }).fail(function(){
            app.showMessage('red', '无法重新生成sitemap');
        }).always(function(){
            $('#rebuild').removeClass('loading');
        });
    });

    $('.ui.form').addClass('loading');
    var pc = getChangefreq('postsChangefreq');
    var cc = getChangefreq('catsChangefreq');
    var tc = getChangefreq('tagsChangefreq');
    var pp = getPriority('postsPriority');
    var cp = getPriority('catsPriority');
    var tp = getPriority('tagsPriority');
    $.when(pc, cc, tc, pp, cp, tp).always(function(){
        $('.ui.form').removeClass('loading');
        $('.ui.dropdown').dropdown();
    });

    patchChangefreq('postsChangefreq');
    patchChangefreq('catsChangefreq');
    patchChangefreq('tagsChangefreq');
    patchPriority('postsPriority');
    patchPriority('catsPriority');
    patchPriority('tagsPriority');
} // end pageInit
</script>
