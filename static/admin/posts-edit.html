<div style="text-align:left">
    <h1 class="header">编辑文章</h1>
    <div class="ui form" id="post"></div>
</div>

<script>
function pageInit(id) {
    if (id>0) {
        app.setTitle('编辑文章');
        $('h1.header').html('编辑文章');
    }else{
        app.setTitle('添加文章');
        $('h1.header').html('添加文章');
    }

    var load = true
    var selectedTags = {} // 用于保存当前文章的标签
    if (id>0) {
        load = app.get({
            'url': app.adminAPI('/posts/'+id)
        }).done(function(data, textStatus, jqXHR){
            app.loadTemplate("#post", "#post-template", data);
            selectedTags = data.tags;
        });
    }else{
        app.loadTemplate("#post", "#post-template");
    }

    $.when(load).then(function(){
        return app.get({
            'url': app.adminAPI('/tags')
        }).done(function(data, textStatus, jqXHR){
            // 比较标签，记录当前文章的标签值。
            for (var i = 0; i < data.tags.length; i++) {
                for (var j = 0; j < selectedTags.length; j++) {
                    if (data.tags[i].id == selectedTags[j].id){
                        data.tags[i].selected = true;
                        break;
                    }
                }
            }
            app.loadTemplate("#tags", "#tags-template", data);
        });
    }).then(function(){
        $('.ui.checkobx').checkbox();
        $('.ui.accordion').accordion();
        $('.ui.dropdown').dropdown(/*{allowAdditions:true}*/);

        // 初始按钮动作
        $('#draft').on('click', function(){
            $('#state').val(2);
            submit();
        });
        $('#published').on('click', function(){
            $('#state').val(1);
            submit();
        });

        // 提交数据
        function submit(){
            var data = app.buildObject($('.ui.form'));
            for (var i = 0; i < data.tags.length; i++) {
                data.tags[i] = parseInt(data.tags[i]);
            }
            if (id>0){
                app.put({
                    'url': app.adminAPI('/posts/')+id,
                    'data':JSON.stringify(data)
                }).done(function(){
                    app.showMessage('green', "更新成功");
                    app.redirect('#posts/list');
                });
            }else{
                app.post({
                    'url': app.adminAPI('/posts'),
                    'data':JSON.stringify(data)
                }).done(function(){
                    app.showMessage('green', "添加成功");
                    app.redirect('#posts/list');
                });
            }
        }
    });
} // end pageInit
</script>

<script id="tags-template" type="x-handlebars-template">
{{#each tags}}
    <option {{#if selected}}selected="selected"{{/if}} value="{{id}}">{{title}}</option>
{{/each}}
</script>

<script id="post-template" type="x-handlebars-template">
    <input id="state" name="state" value="" type="hidden" data-type="int" />
    <div class="field">
        <input name="title" type="text" required="required" placeholder="标题" value="{{title}}" />
    </div>

    <!-- tags -->
    <select id="tags" class="ui fluid multiple search selection dropdown field" multiple="multiple" name="tags">
    </select>
    <!-- end tags -->

    <div class="ui accordion field" style="margin-bottom:1em">
        <div class="title"><i class="dropdown icon"></i>高级</div>
        <div class="content">
            <div class="field">
                <input name="name" type="text" placeholder="唯一名称" value="{{name}}" />
            </div>

            <div class="field">
                <textarea name="summary" rows="10" cols="40" placeholder="文章摘要">{{summary}}</textarea>
            </div>

            <div class="field">
                <div class="ui checkbox" style="margin-right:2em">
                    <input data-type="bool" id="allowComment" type="checkbox" name="allowComment" value="1" {{#if allowComment}}checked="checked"{{/if}} />
                    <label for="allowComment" style="cursor:pointer">允许评论</label>
                </div>

                <div class="ui checkbox">
                    <input data-type="bool" id="allowPing" type="checkbox" name="allowPing" value="1" {{#if allowPing}}checked="checked"{{/if}} />
                    <label for="allowPing" style="cursor:pointer">允许Ping</label>
                </div>
            </div>
        </div>
    </div>

    <div class="field">
        <textarea name="content" required="required" rows="20" cols="40" placeholder="文章正文">{{content}}</textarea>
    </div>

    <div class="ui divider"></div>
    <div class="ui buttons field right floated">
        <button class="ui red submit button" id="draft">保存为草稿</button>
        <button class="ui green submit button" id="published">发布</button>
    </div>
</script>
